{% extends 'admin_base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-100 px-4 py-8">
    <div class="max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold mb-6">Order Management</h2>

        <!-- Search, Sort, Filter -->
        <div class="bg-white p-4 rounded-xl shadow-md mb-6">
            <form method="GET" class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="flex-1">
                    <label for="q" class="block text-sm font-medium text-gray-700">Search</label>
                    <input type="text" name="q" id="q" value="{{ search_query }}" placeholder="Search by Order ID or User" class="w-full border rounded-md p-2 text-sm">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Filter by Status</label>
                    <select name="status" id="status" class="w-full border rounded-md p-2 text-sm">
                        <option value="">All Statuses</option>
                        {% for status_value, status_label in status_choices %}
                            <option value="{{ status_value }}" {% if filter_status == status_value %}selected{% endif %}>{{ status_label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="sort" class="block text-sm font-medium text-gray-700">Sort By</label>
                    <select name="sort" id="sort" class="w-full border rounded-md p-2 text-sm">
                        <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Date (Newest First)</option>
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Date (Oldest First)</option>
                        <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status (A-Z)</option>
                        <option value="-status" {% if sort_by == '-status' %}selected{% endif %}>Status (Z-A)</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Apply</button>
                    <a href="{% url 'admin_order_list' %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Clear</a>
                </div>
            </form>
        </div>

        <!-- Order List -->
        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for order in page_obj %}
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ order.order_id }}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">{{ order.created_at|date:"m/d/Y H:i" }}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {{ order.user.username }} ({{ order.user.email }})
                            {% if order.user.mobile %}<br>{{ order.user.mobile }}{% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if order.status == 'pending' %}bg-blue-100 text-blue-800
                                {% elif order.status == 'shipped' %}bg-yellow-100 text-yellow-800
                                {% elif order.status == 'out_for_delivery' %}bg-orange-100 text-orange-800
                                {% elif order.status == 'delivered' %}bg-green-100 text-green-700
                                {% elif order.status == 'cancelled' %}bg-red-100 text-red-700{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">â‚¹{{ order.total_amount|floatformat:2 }}</td>
                        <td class="px-6 py-4 text-sm">
                            <a href="{% url 'admin_order_detail' order.id %}" class="text-blue-600 hover:text-blue-800">View</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-sm text-gray-500 text-center">No orders found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="mt-4 flex justify-center">
            <nav class="inline-flex rounded-md shadow">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&sort={{ sort_by }}&status={{ filter_status }}" class="px-3 py-2 text-sm text-gray-500 hover:bg-gray-100">Previous</a>
                {% endif %}
                <span class="px-3 py-2 text-sm text-gray-700">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&sort={{ sort_by }}&status={{ filter_status }}" class="px-3 py-2 text-sm text-gray-500 hover:bg-gray-100">Next</a>
                {% endif %}
            </nav>
        </div>
    </div>

    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            {% for message in messages %}
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: '{{ message.tags }}' === 'success' ? 'success' : '{{ message.tags }}' === 'error' ? 'error' : 'warning',
                    title: '{{ message }}',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                });
            {% endfor %}
        });
    </script>
</div>
{% endblock %}