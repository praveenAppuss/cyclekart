{% extends 'header.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-white py-10 px-4">
  <div class="max-w-6xl mx-auto">

    <h2 class="text-xl font-bold text-gray-800 mb-6">Your Cart</h2>

    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Cart Items -->
      <div class="lg:col-span-2 space-y-5">
        {% for item in cart_items %}
        <div class="flex justify-between items-center bg-white rounded-xl border border-gray-100 hover:shadow-sm p-3 transition-shadow {% if not item.is_available %}opacity-50{% endif %}" data-item-id="{{ item.id }}">
          <div class="flex items-center space-x-5">
            <img src="{{ item.image }}" alt="{{ item.product.name }}" class="w-20 h-20 rounded-sm object-contain border border-gray-100" onerror="this.src='{% static 'images/placeholder.png' %}'; this.onerror=null;">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">{{ item.product.name }}</h3>
              <div class="flex items-center mt-1 text-sm space-x-6 text-gray-600">
                <div class="flex items-center gap-1">
                  Color:
                  {% if item.color_variant and item.color_variant.hex_code %}
                    <span class="inline-block w-4 h-4 rounded-full border ml-1" style="background-color: {{ item.color_variant.hex_code }}"></span>
                  {% else %}
                    <span class="text-gray-400">N/A</span>
                  {% endif %}
                </div>
                <div>Size: <span class="font-medium">{{ item.size_display }}</span></div>
                {% if item.is_available %}
                  <div class="text-green-600 font-medium">In Stock</div>
                {% else %}
                  <div class="text-red-600 font-medium">Unavailable{% if item.stock == 0 %} (Out of Stock){% endif %}</div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-5">
            <!-- Display only the original price (price field) -->
            <span class="text-md font-semibold text-gray-900" data-unit-price>
              â‚¹{{ item.product.price|floatformat:0 }}
            </span>
            <div class="flex items-center space-x-2">
              {% if item.is_available %}
                <button onclick="updateQuantity('{{ item.id }}', 'decrement')"
                        class="decrement-btn px-2 py-1 rounded {% if item.quantity <= 1 %}bg-gray-300 cursor-not-allowed{% else %}bg-gray-200 hover:bg-gray-300{% endif %}"
                        data-max-quantity="{{ item.max_quantity }}"
                        {% if item.quantity <= 1 %}disabled{% endif %}>âˆ’</button>
                <span class="px-2 font-semibold quantity-display">{{ item.quantity }}</span>
                <button onclick="updateQuantity('{{ item.id }}', 'increment')"
                        class="increment-btn px-2 py-1 rounded {% if item.quantity >= item.max_quantity %}bg-gray-300 cursor-not-allowed{% else %}bg-gray-200 hover:bg-gray-300{% endif %}"
                        data-max-quantity="{{ item.max_quantity }}"
                        {% if item.quantity >= item.max_quantity %}disabled{% endif %}>+</button>
              {% else %}
                <span class="px-2 font-semibold">{{ item.quantity }}</span>
              {% endif %}
            </div>
            <button onclick="openRemoveModal('{{ item.id }}')" class="text-red-600 hover:text-red-800">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>
        {% endfor %}
        <hr class="border-gray-200">
      </div>

      <!-- Order Summary -->
      <div class="bg-white rounded border border-gray-100 shadow p-4 sticky top-20">
        <h2 class="text-xl font-medium text-gray-800 mb-4">Order Summary</h2>
        <div class="space-y-2 text-gray-700 text-sm">
          <div class="flex justify-between">
            <span>Subtotal</span>
            <span class="font-medium" data-cart-total>â‚¹{{ cart_total|floatformat:0 }}</span>
          </div>
          <div class="flex justify-between">
            <span>Total Discount</span>
            <span class="font-medium text-green-600" data-total-discount>-â‚¹{{ total_discount|floatformat:0 }}</span>
          </div>
          <div class="flex justify-between">
            <span>Shipping</span>
            <span class="font-medium text-green-600">Free</span>
          </div>
          <div class="flex justify-between">
            <span>Tax</span>
            <span class="font-medium" data-taxes>â‚¹{{ taxes|floatformat:2 }}</span>
          </div>
          <hr class="border-gray-100">
          <div class="flex justify-between text-lg font-medium text-gray-900">
            <span>Total</span>
            <span data-final-total>â‚¹{{ total|floatformat:2 }}</span>
          </div>
        </div>
        {% if cart_items and not has_unavailable_items %}
          <a href="{% url 'checkout' %}" class="mt-6 block text-center bg-gray-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">Proceed to Checkout</a>
          <a href="{% url 'userproduct_list' %}" class="mt-5 block text-black-100 hover:underline text-xs text-center">Continue Shopping</a>
        {% else %}
          <button disabled class="mt-6 block text-center bg-gray-400 text-white px-4 py-2 rounded-lg font-medium cursor-not-allowed">Proceed to Checkout</button>
        {% endif %}
      </div>
    </div>
    {% else %}
    <div class="text-center py-20">
      <h3 class="text-xl font-semibold text-gray-600 mb-2">Your cart is empty ðŸ›’</h3>
      <a href="{% url 'userproduct_list' %}" class="text-blue-600 hover:underline">Continue Shopping</a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Remove Confirmation Modal -->
<div id="removeModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full text-center space-y-4">
    <h2 class="text-xl font-semibold text-gray-800">Remove Item</h2>
    <p class="text-gray-600">Are you sure you want to remove this item from your cart?</p>
    <form id="removeForm" method="POST">
      {% csrf_token %}
      <div class="flex justify-center space-x-4 mt-4">
        <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">Yes, Remove</button>
        <button type="button" onclick="closeRemoveModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript for SweetAlert2 Toast and Other Functionality -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // No toast initialization needed anymore
  });

  function openRemoveModal(itemId) {
    const modal = document.getElementById("removeModal");
    const form = document.getElementById("removeForm");
    form.action = `/cart/remove/${itemId}/`;
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeRemoveModal() {
    const modal = document.getElementById("removeModal");
    modal.classList.remove("flex");
    modal.classList.add("hidden");
  }

  function showToast(message, type) {
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer);
        toast.addEventListener('mouseleave', Swal.resumeTimer);
      }
    });

    if (type === "success") {
      Toast.fire({
        icon: 'success',
        title: message,
        customClass: {
          popup: 'animated fadeInDown'
        }
      });
    } else if (type === "error") {
      Toast.fire({
        icon: 'error',
        title: message,
        customClass: {
          popup: 'animated fadeInDown'
        }
      });
    } else { // warning
      Toast.fire({
        icon: 'warning',
        title: message,
        customClass: {
          popup: 'animated fadeInDown'
        }
      });
    }
  }

  async function updateQuantity(itemId, action) {
    const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
    const quantityDisplay = itemElement.querySelector('.quantity-display');
    const unitPriceDisplay = itemElement.querySelector('[data-unit-price]'); // Reference to the fixed price
    const incrementBtn = itemElement.querySelector('.increment-btn');
    const decrementBtn = itemElement.querySelector('.decrement-btn');
    const maxQuantity = parseInt(incrementBtn.dataset.maxQuantity || 5);

    // Prevent action if buttons are disabled
    if ((action === 'increment' && incrementBtn.disabled) || (action === 'decrement' && decrementBtn.disabled)) {
      return;
    }

    try {
      const response = await fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `action=${action}`
      });

      const data = await response.json();
      if (data.success) {
        quantityDisplay.textContent = data.quantity;
        // Do not update unitPriceDisplay, keep it fixed
        showToast(data.message, 'success');

        // Update button states
        const newQuantity = data.quantity;
        incrementBtn.disabled = newQuantity >= maxQuantity;
        decrementBtn.disabled = newQuantity <= 1;
        incrementBtn.classList.toggle('bg-gray-300', newQuantity >= maxQuantity);
        incrementBtn.classList.toggle('cursor-not-allowed', newQuantity >= maxQuantity);
        incrementBtn.classList.toggle('bg-gray-200', newQuantity < maxQuantity);
        incrementBtn.classList.toggle('hover:bg-gray-300', newQuantity < maxQuantity);
        decrementBtn.classList.toggle('bg-gray-300', newQuantity <= 1);
        decrementBtn.classList.toggle('cursor-not-allowed', newQuantity <= 1);
        decrementBtn.classList.toggle('bg-gray-200', newQuantity > 1);
        decrementBtn.classList.toggle('hover:bg-gray-300', newQuantity > 1);

        // Update order summary
        document.querySelector('[data-cart-total]').textContent = `â‚¹${data.cart_total.toFixed(0)}`;
        document.querySelector('[data-total-discount]').textContent = `-â‚¹${data.total_discount.toFixed(0)}`;
        document.querySelector('[data-taxes]').textContent = `â‚¹${data.taxes.toFixed(2)}`;
        document.querySelector('[data-final-total]').textContent = `â‚¹${data.total.toFixed(2)}`;
      } else {
        showToast(data.message, 'error');
      }
    } catch (error) {
      showToast('An error occurred. Please try again.', 'error');
    }
  }
</script>
{% endblock %}