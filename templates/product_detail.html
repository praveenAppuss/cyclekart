<!-- Updated product_detail.html -->
<!-- Add this to <head> or extra CSS block for Font Awesome (optional; using SVG for consistency) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- In the template, replace the existing content block with this (key changes: rating near title, tabs after description, reviews section, JS updates) -->
{% extends 'header.html' %}
{% load static %}

{% block content %}
<!-- Include SweetAlert2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="min-h-screen bg-gray-100">
  <div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-6">
      <a href="{% url 'userproduct_list' %}" class="hover:text-gray-900 transition-colors">Products</a>
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
      <span class="text-gray-900 font-medium">{{ product.name }}</span>
    </nav>

    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">

        <!-- Image with magnifier zoom -->
        <div class="bg-gray-50 p-4 relative">
          <div class="relative w-full max-w-md mx-auto">
            <div id="imageWrapper" class="relative aspect-square border border-gray-200 overflow-hidden bg-white">
              {% with color_variants.first.images.first as initial_image %}
                <img id="mainImage" src="{{ initial_image.image.url|default:product.thumbnail.url }}" alt="{{ product.name }}"
                     class="w-full h-full object-contain p-2 transition-opacity duration-300">
              {% endwith %}
              <div id="lens" class="absolute hidden border-2 border-gray-300 bg-white/50 pointer-events-none z-40"></div>
            </div>

            <!-- Zoom box -->
            <div id="zoomBox" style="width: 400px; height: 400px;"
                 class="hidden absolute top-0 left-full ml-6 z-50 border border-gray-200 shadow-lg overflow-hidden bg-white">
              <img id="zoomedImage" src="{{ initial_image.image.url|default:product.thumbnail.url }}"
                   class="absolute object-cover max-w-none pointer-events-none" />
            </div>

            <!-- Thumbnails -->
            <div id="thumbnailContainer" class="flex justify-center space-x-3 mt-4">
              {% for image in color_variants.first.images.all %}
                <img src="{{ image.image.url }}" onclick="changeImage('{{ image.image.url }}')"
                     class="w-14 h-14 object-contain border border-gray-200 cursor-pointer hover:ring-2 ring-indigo-500 transition-all duration-200">
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Product Details -->
        <div class="space-y-6">
          <h1 class="text-3xl font-semibold text-gray-900">{{ product.name }}</h1>

          <!-- Dynamic Rating Display (replaces static) -->
          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center space-x-2">
              <div class="flex text-yellow-400">
                {% for _ in star_display.full %}
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                {% endfor %}
                {% if star_display.half %}
                  <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" clip-path="url(#half-clip)" />
                    <defs><clipPath id="half-clip"><rect x="0" y="0" width="10" height="20"/></clipPath></defs>
                  </svg>
                {% endif %}
                {% for _ in star_display.empty %}
                  <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 20 20">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.049 2.929l.384 1.375c.044.154.14.316.282.343l1.377.63-1.38 1.337a.568.568 0 00-.18.557l.43 1.295a.55.55 0 01-.81.638l-1.285-.528a.562.562 0 00-.63.16l-1.14 1.16a.562.562 0 00.18.557l1.38 1.337-.544 1.989a.558.558 0 001.003.606l1.3-.789 1.3.789a.558.558 0 001.003-.606l-.544-1.989 1.38-1.337a.568.568 0 00-.18-.557l-1.38-1.337.384-1.375a.558.558 0 00-.63-.16l-1.285.528a.562.562 0 01-.81-.638l.43-1.295a.558.558 0 00-.18-.557l-1.38-1.337 1.377-.63a1 1 0 00.282-.343L9.049 2.929z" />
                  </svg>
                {% endfor %}
              </div>
              <span class="text-indigo-600">({{ reviews_count }} Review{{ reviews_count|pluralize }})</span>
            </div>
            <span id="stockStatus" class="text-xs font-medium px-2 py-1 rounded-full"></span>
          </div>

          <!-- Price Section -->
          <div class="text-2xl font-bold text-gray-900">
            {% if final_price < product.price %}
              <span>₹{{ final_price|floatformat:0 }}</span>
              <span class="text-sm text-red-500 line-through ml-2">₹{{ product.price|floatformat:0 }}</span>
              {% if savings > 0 %}
                <span class="text-green-500 text-sm ml-2">
                  You save ₹{{ savings|floatformat:0 }}
                  {% if best_discount > 0 %}
                    ({{ best_discount }}% off)
                  {% endif %}
                </span>
              {% endif %}
            {% else %}
              <span>₹{{ product.price|floatformat:0 }}</span>
            {% endif %}
          </div>

          <!-- Available Colors -->
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2">Available Colors</h3>
            <div class="flex gap-2" id="colorOptions">
              {% if color_variants.count == 1 %}
                {% with color_variants.first as single_variant %}
                  <div class="w-6 h-6 rounded-full border-2 border-gray-300"
                       style="background-color: {{ single_variant.hex_code|default:'#000' }}"
                       title="{{ single_variant.name }}"
                       data-color="{{ single_variant.name }}"
                       data-variant-id="{{ single_variant.id }}">
                  </div>
                  <input type="hidden" id="singleColorVariant" name="color_variant" value="{{ single_variant.id }}">
                {% endwith %}
              {% else %}
                {% for variant in color_variants %}
                  <div class="w-6 h-6 rounded-full border-2 border-gray-300 cursor-pointer
                              {% if variant.has_stock %}hover:ring-2 ring-indigo-500{% else %}opacity-50 cursor-not-allowed{% endif %}
                              {% if forloop.first %}ring-2 ring-indigo-500{% endif %}"
                       style="background-color: {{ variant.hex_code|default:'#000' }}"
                       data-color="{{ variant.name }}"
                       data-variant-id="{{ variant.id }}"
                       onclick="selectColor(this)">
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          </div>

          <!-- Size -->
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2">Select Size</h3>
            <div class="flex gap-2" id="sizeOptions">
              <!-- Sizes will be populated dynamically by JavaScript -->
            </div>
          </div>

          <!-- Quantity Selector -->
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2">Quantity</h3>
            <div class="flex items-center gap-4">
              <button id="decreaseQty" disabled class="w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors"
                      aria-label="Decrease quantity">-</button>
              <input type="text" id="quantity" class="w-10 h-6 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                     value="1" readonly>
              <button id="increaseQty" disabled class="w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors"
                      aria-label="Increase quantity">+</button>
            </div>
          </div>

          <!-- Add to Cart and Wishlist -->
          <div class="flex space-x-4 mt-6">
            <form method="post" action="{% url 'add_to_cart' product.id %}" class="flex-1">
              {% csrf_token %}
              <input type="hidden" name="quantity" id="formQuantity" value="1">
              <input type="hidden" name="size_stock" id="formSizeStock" value="">
              {% if color_variants.count == 1 %}
                <input type="hidden" name="color_variant" id="formColorVariant" value="{{ color_variants.first.id }}">
              {% else %}
                <input type="hidden" name="color_variant" id="formColorVariant" value="{% if color_variants.count > 0 %}{{ color_variants.first.id }}{% endif %}">
              {% endif %}
              <button id="addToCartBtn" disabled type="submit"
                      class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                      aria-label="Add {{ product.name }} to cart">
                Add to Cart
              </button>
            </form>
            <form method="post" action="" id="wishlistForm" class="w-12">
              {% csrf_token %}
              <button id="wishlistBtn" type="submit"
                      class="w-12 h-12 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-100 transition-colors"
                      aria-label="Toggle wishlist">
                <svg id="wishlistIcon" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Tabs: Details | Reviews -->
      <div class="mt-8 pt-6 border-t border-gray-200 mx-6">
        <div class="flex border-b border-gray-200 mb-4">
          <button id="detailsTab" class="text-sm font-semibold text-gray-900 pb-4 border-b-2 border-indigo-600 mr-8 focus:outline-none">Details</button>
          <button id="reviewsTab" class="text-sm text-gray-600 pb-4 hover:text-gray-900 focus:outline-none">Reviews ({{ reviews_count }})</button>
        </div>

        <!-- Tab Contents -->
        <div id="detailsContent">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Details</h3>
          <p class="text-gray-600">{{ product.description|default:'No description available' }}</p>
        </div>

        <div id="reviewsContent" class="hidden">
          <!-- Average Rating Summary -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Customer Reviews</h3>
            <div class="flex items-center space-x-2 mt-2">
              <span class="text-3xl font-bold text-gray-900">{{ avg_rating|floatformat:1 }}</span>
              <div class="flex text-yellow-400">
                {% for _ in star_display.full %}
                  <i class="fas fa-star text-xl"></i>
                {% endfor %}
                {% if star_display.half %}
                  <i class="fas fa-star-half-alt text-xl"></i>
                {% endif %}
                {% for _ in star_display.empty %}
                  <i class="far fa-star text-xl text-gray-300"></i>
                {% endfor %}
              </div>
            </div>
            <p class="text-gray-600 text-sm">{{ reviews_count }} Review{{ reviews_count|pluralize }}</p>
          </div>

          <!-- Existing Reviews -->
          <div id="reviewsList" class="space-y-6 mb-8">
            {% for review in reviews %}
              {% include 'review_item.html' with review=review %}
            {% empty %}
              <p class="text-gray-500 text-center py-8">No reviews yet. Be the first to review this product!</p>
            {% endfor %}
          </div>

          <!-- Review Form (if eligible) -->
          {% if can_review %}
            <div class="border-t border-gray-200 pt-6">
              <h4 class="text-md font-semibold mb-4">Leave a Review</h4>
              <form method="POST" id="reviewForm" class="space-y-4">
                {% csrf_token %}
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Your Rating</label>
                  <div class="flex space-x-1 text-yellow-500" id="starContainer">
  {% for i in "12345" %}
    <i class="fas fa-star text-2xl cursor-pointer hover:text-yellow-600 transition-colors 
              {% if initial_rating >= forloop.counter %}filled{% else %}empty{% endif %}"
       data-value="{{ forloop.counter }}"></i>
  {% endfor %}
</div>
<input type="hidden" name="rating" id="ratingInput" value="{{ initial_rating }}">
                  {% if form.rating.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.rating.errors.0 }}</p>
                  {% endif %}
                </div>
                <div>
                  {{ form.comment.label_tag }}
                  {{ form.comment }}
                  {% if form.comment.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.comment.errors.0 }}</p>
                  {% endif %}
                </div>
                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Submit Review</button>
              </form>
            </div>
          {% elif user.is_authenticated %}
            <p class="text-gray-500 text-center py-8">You must purchase and receive this product to leave a review.</p>
          {% else %}
            <p class="text-gray-500 text-center py-8">Log in to leave a review.</p>
          {% endif %}
        </div>
      </div>

      <!-- Related Products Section -->
      <div class="mt-12 border-t border-gray-200 pt-8 pb-8 mx-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">You May Also Like</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4">
          {% for item in related_products %}
          <a href="{% url 'product_detail' item.id %}" class="group bg-white rounded-lg border border-gray-200 overflow-hidden hover:shadow-lg hover:border-gray-200 transition-all duration-300">
            <!-- Product Image -->
            <div class="aspect-square bg-gray-50/50 overflow-hidden relative">
              <img 
                src="{{ item.thumbnail.url }}" 
                alt="{{ item.name }}" 
                class="w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300"
              >
              <!-- Quick View Button -->
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center">
                <button class="bg-white text-gray-900 px-3 py-1.5 rounded-md text-xs font-medium opacity-0 group-hover:opacity-100 transition-all transform translate-y-2 group-hover:translate-y-0 shadow-lg">
                  Quick View
                </button>
              </div>
            </div>
            
            <!-- Product Info -->
            <div class="p-3">
              <h3 class="font-medium text-gray-900 text-sm mb-1 line-clamp-2 group-hover:text-gray-700 transition-colors">
                {{ item.name }}
              </h3>
              <div class="flex items-center justify-between">
                {% with final_price=item.get_final_price savings=item.get_savings %}
                  {% if final_price < item.price %}
                    <p class="text-base font-semibold text-gray-900">₹{{ final_price|floatformat:0 }}</p>
                    <p class="text-xs text-red-400 line-through">₹{{ item.price|floatformat:0 }}</p>
                  {% else %}
                    <p class="text-base font-semibold text-gray-900">₹{{ item.price|floatformat:0 }}</p>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </a>
          {% empty %}
          <div class="col-span-full text-center py-8 text-gray-500">
            <p>No related products found.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create a new file: templates/review_item.html -->
<!-- Partial for individual review (used in loop and AJAX) -->
<!-- <div id="reviewsList" class="space-y-6 mb-8">
  {% for review in reviews %}
    {% include 'review_item.html' with review=review %}
  {% empty %}
    <p class="text-gray-500 text-center py-8">No reviews yet. Be the first to review this product!</p>
  {% endfor %}
</div> -->

<!-- CSS for lens, zoom, size options, wishlist, tabs, stars, etc. (merged <style> block) -->
<style>
  
  #lens {
    width: 100px;
    height: 100px;
  }

  #zoomedImage {
    position: absolute;
    top: 0;
    left: 0;
  }

  .size-option {
    width: 2.5rem;
    height: 2.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: white;
    font-weight: 500;
  }

  .size-option:hover {
    background-color: #f9fafb;
    border-color: #d1d5db;
  }

  .size-option.selected {
    background-color: #4b5563;
    color: white;
    border-color: #4b5563;
  }

  .size-option.out-of-stock {
    background-color: #e5e7eb;
    color: #9ca3af;
    cursor: not-allowed;
    border-color: #d1d5db;
  }

  .color-option.selected {
    ring: 2px solid #4b5563;
  }

  #wishlistBtn.wishlisted svg {
    fill: #ef4444;
    stroke: #ef4444;
  }
  #starContainer i.filled {
  color: #fbbf24;
  }
  #starContainer i.empty {
    color: #d1d5db;
  }
  #starContainer i:hover,
  #starContainer i:hover ~ i {
    color: #fbbf24 !important;
  }

  /* Tabs styles */
  #detailsTab.active, #reviewsTab.active {
    @apply text-gray-900 border-b-2 border-indigo-600;
  }
  #detailsContent, #reviewsContent {
    @apply transition-opacity duration-300;
  }
  #reviewsContent.hidden {
    display: none;
  }
  /* Star hover for form */
  #starContainer i:hover,
  #starContainer i:hover ~ i {
    color: #fbbf24 !important;
  }
  /* Half-star clip-path fix if needed */
</style>

<!-- Merged JavaScript (includes existing + tabs/review logic) -->
<script>
  // Pass color_variants and wishlist status from view to JavaScript
  const colorVariants = [
    {% for variant in color_variants %}
      {
        id: {{ variant.id }},
        name: "{{ variant.name }}",
        hasStock: {{ variant.has_stock|yesno:"true,false" }},
        images: [{% for image in variant.images.all %}"{{ image.image.url }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        sizes: [
          {% for size_stock in variant.size_stocks.all %}
            { id: {{ size_stock.id }}, size: "{{ size_stock.size }}", quantity: {{ size_stock.quantity }}, display: "{{ size_stock.size }}" }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ]
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  const wishlistedVariants = [
    {% for item in wishlist_items %}
      {{ item.color_variant.id }}{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  document.addEventListener("DOMContentLoaded", function () {
    const mainImage = document.getElementById("mainImage");
    const zoomedImage = document.getElementById("zoomedImage");
    const lens = document.getElementById("lens");
    const zoomBox = document.getElementById("zoomBox");
    const zoomLevel = 2.5;
    const sizeOptionsContainer = document.getElementById("sizeOptions");
    const colorOptions = document.querySelectorAll("#colorOptions div");
    const thumbnailContainer = document.getElementById("thumbnailContainer");
    const addToCartBtn = document.getElementById("addToCartBtn");
    const formSizeStock = document.getElementById("formSizeStock");
    const formColorVariant = document.getElementById("formColorVariant");
    const formQty = document.getElementById("formQuantity");
    const qtyInput = document.getElementById("quantity");
    const incBtn = document.getElementById("increaseQty");
    const decBtn = document.getElementById("decreaseQty");
    const singleColorVariantInput = document.getElementById("singleColorVariant");
    const wishlistForm = document.getElementById("wishlistForm");
    const wishlistBtn = document.getElementById("wishlistBtn");
    const wishlistIcon = document.getElementById("wishlistIcon");
    const stockStatus = document.getElementById("stockStatus");

    let selectedColorVariantId = singleColorVariantInput ? parseInt(singleColorVariantInput.value) : (colorVariants.length > 0 ? colorVariants[0].id : null);
    let selectedSizeStockId = null;
    let maxQuantity = 0;

    // Update thumbnails for selected color
    function updateThumbnails(images) {
      thumbnailContainer.innerHTML = "";
      if (images && images.length > 0) {
        images.forEach(image => {
          const img = document.createElement("img");
          img.src = image;
          img.onclick = () => changeImage(image);
          img.className = "w-14 h-14 object-contain border border-gray-200 cursor-pointer hover:ring-2 ring-indigo-500 transition-all duration-200";
          thumbnailContainer.appendChild(img);
        });
      }
    }

    // Update size options for selected color variant
    function updateSizeOptions(colorVariantId) {
      const variant = colorVariants.find(v => v.id === colorVariantId);
      sizeOptionsContainer.innerHTML = "";
      if (variant && variant.sizes && variant.sizes.length > 0) {
        variant.sizes.forEach(size => {
          const div = document.createElement("div");
          div.className = `size-option ${size.quantity > 0 ? '' : 'out-of-stock'}`;
          div.dataset.sizeStockId = size.id;
          div.dataset.stock = size.quantity;
          div.textContent = size.display;
          div.onclick = function() { selectSize(this); };
          sizeOptionsContainer.appendChild(div);
        });
        selectedSizeStockId = null;
        formSizeStock.value = "";
        updateStockAndButtons();
      } else {
        sizeOptionsContainer.innerHTML = '<p class="text-sm text-red-600">No sizes available</p>';
      }
    }

    // Handle color selection
    function selectColor(element) {
      if (!element || element.classList.contains("opacity-50") || !element.dataset.variantId) return;
      colorOptions.forEach(o => o.classList.remove("ring-2", "ring-indigo-500"));
      element.classList.add("ring-2", "ring-indigo-500");
      selectedColorVariantId = parseInt(element.dataset.variantId);
      formColorVariant.value = selectedColorVariantId;
      wishlistForm.action = `/wishlist/add/${selectedColorVariantId}/`;
      wishlistBtn.dataset.variantId = selectedColorVariantId;
      const variant = colorVariants.find(v => v.id === selectedColorVariantId);
      if (variant && variant.images && variant.images.length > 0) {
        updateThumbnails(variant.images);
        changeImage(variant.images[0]);
      }
      updateSizeOptions(selectedColorVariantId);
      updateStockStatus();
      updateWishlistButton();
      updateStockAndButtons();
    }

    // Handle size selection
    function selectSize(element) {
      if (element.classList.contains("out-of-stock")) return;
      sizeOptionsContainer.querySelectorAll(".size-option").forEach(o => o.classList.remove("selected"));
      element.classList.add("selected");
      selectedSizeStockId = parseInt(element.dataset.sizeStockId);
      formSizeStock.value = selectedSizeStockId;
      maxQuantity = Math.min(parseInt(element.dataset.stock), 5);
      qtyInput.value = 1;
      formQty.value = 1;
      updateStockAndButtons();
    }

    // Update stock status
    function updateStockStatus() {
      const variant = colorVariants.find(v => v.id === selectedColorVariantId);
      if (variant) {
        if (variant.hasStock) {
          stockStatus.textContent = "In Stock";
          stockStatus.className = "text-green-600 bg-green-50 px-2 py-1 rounded-full text-xs font-medium";
        } else {
          stockStatus.textContent = "Out of Stock";
          stockStatus.className = "text-red-600 bg-red-50 px-2 py-1 rounded-full text-xs font-medium";
        }
      }
    }

    // Update button states
    function updateStockAndButtons() {
      const hasColor = !!selectedColorVariantId;
      const hasSize = !!selectedSizeStockId;
      const quantity = parseInt(qtyInput.value);

      incBtn.disabled = !hasSize || quantity >= maxQuantity;
      decBtn.disabled = !hasSize || quantity <= 1;
      addToCartBtn.disabled = !hasSize || !hasColor;

      incBtn.classList.toggle("bg-gray-200", !hasSize || quantity >= maxQuantity);
      incBtn.classList.toggle("bg-indigo-600", hasSize && quantity < maxQuantity);
      incBtn.classList.toggle("text-gray-600", !hasSize || quantity >= maxQuantity);
      incBtn.classList.toggle("text-white", hasSize && quantity < maxQuantity);

      decBtn.classList.toggle("bg-gray-200", !hasSize || quantity <= 1);
      decBtn.classList.toggle("bg-indigo-600", hasSize && quantity > 1);
      decBtn.classList.toggle("text-gray-600", !hasSize || quantity <= 1);
      decBtn.classList.toggle("text-white", hasSize && quantity > 1);

      addToCartBtn.classList.toggle("bg-gray-400", !hasSize || !hasColor);
      addToCartBtn.classList.toggle("bg-indigo-600", hasSize && hasColor);
    }

    // Update wishlist button state
    function updateWishlistButton() {
      const isWishlisted = wishlistedVariants.includes(selectedColorVariantId);
      wishlistBtn.classList.toggle("wishlisted", isWishlisted);
      wishlistBtn.setAttribute("aria-label", isWishlisted ? `Remove ${selectedColorVariantId} from wishlist` : `Add ${selectedColorVariantId} to wishlist`);
    }

    // Handle wishlist toggle
    wishlistBtn.addEventListener("click", async function (e) {
      e.preventDefault();
      if (!selectedColorVariantId) return;

      const formData = new FormData(wishlistForm);
      try {
        const response = await fetch(`/wishlist/add/${selectedColorVariantId}/`, {
          method: "POST",
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData,
        });
        const data = await response.json();
        if (data.success) {
          if (data.added) {
            wishlistedVariants.push(selectedColorVariantId);
          } else {
            wishlistedVariants.splice(wishlistedVariants.indexOf(selectedColorVariantId), 1);
          }
          updateWishlistButton();
          showSweetAlert(data.message, data.added ? "success" : "info");
        } else {
          showSweetAlert(data.message, "error");
        }
      } catch (error) {
        showSweetAlert("An error occurred. Please try again.", "error");
      }
    });

    // Show SweetAlert message
    function showSweetAlert(message, type) {
      Swal.fire({
        text: message,
        icon: type,
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true,
        customClass: {
          popup: 'swal2-small'
        }
      });
    }

    // Image zoom functionality
    const moveLens = (e) => {
      const rect = mainImage.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      let lensX = x - lens.offsetWidth / 2;
      let lensY = y - lens.offsetHeight / 2;
      const maxX = mainImage.offsetWidth - lens.offsetWidth;
      const maxY = mainImage.offsetHeight - lens.offsetHeight;
      lensX = Math.max(0, Math.min(lensX, maxX));
      lensY = Math.max(0, Math.min(lensY, maxY));
      lens.style.left = `${lensX}px`;
      lens.style.top = `${lensY}px`;
      zoomedImage.style.left = `-${lensX * zoomLevel}px`;
      zoomedImage.style.top = `-${lensY * zoomLevel}px`;
      zoomedImage.style.width = `${mainImage.offsetWidth * zoomLevel}px`;
      zoomedImage.style.height = `${mainImage.offsetHeight * zoomLevel}px`;
    };

    mainImage.addEventListener("mouseenter", () => {
      lens.classList.remove("hidden");
      zoomBox.classList.remove("hidden");
    });
    mainImage.addEventListener("mousemove", moveLens);
    mainImage.addEventListener("mouseleave", () => {
      lens.classList.add("hidden");
      zoomBox.classList.add("hidden");
    });

    window.changeImage = function (url) {
      mainImage.src = url;
      zoomedImage.src = url;
      lens.classList.add("hidden");
      zoomBox.classList.add("hidden");
    };

    // Quantity controls
    incBtn.addEventListener("click", () => {
      let current = parseInt(qtyInput.value);
      if (current < maxQuantity) {
        qtyInput.value = current + 1;
        formQty.value = qtyInput.value;
      }
      updateStockAndButtons();
    });

    decBtn.addEventListener("click", () => {
      let current = parseInt(qtyInput.value);
      if (current > 1) {
        qtyInput.value = current - 1;
        formQty.value = qtyInput.value;
      }
      updateStockAndButtons();
    });

    // Color selection
    colorOptions.forEach(option => {
      option.addEventListener("click", () => selectColor(option));
    });

    // Initial state
    if (colorOptions.length > 0) {
      selectedColorVariantId = parseInt(colorOptions[0].dataset.variantId);
      formColorVariant.value = selectedColorVariantId;
      wishlistForm.action = `/wishlist/add/${selectedColorVariantId}/`;
      selectColor(colorOptions[0]);
    } else if (singleColorVariantInput && colorVariants.length > 0) {
      selectedColorVariantId = parseInt(singleColorVariantInput.value);
      formColorVariant.value = selectedColorVariantId;
      wishlistForm.action = `/wishlist/add/${selectedColorVariantId}/`;
      const variant = colorVariants.find(v => v.id === selectedColorVariantId);
      if (variant) {
        if (variant.images && variant.images.length > 0) {
          updateThumbnails(variant.images);
          changeImage(variant.images[0]);
        }
        updateSizeOptions(selectedColorVariantId);
      }
    }
    updateStockStatus();
    updateWishlistButton();
    updateStockAndButtons();

    // Tab functionality
    const detailsTab = document.getElementById('detailsTab');
    const reviewsTab = document.getElementById('reviewsTab');
    const detailsContent = document.getElementById('detailsContent');
    const reviewsContent = document.getElementById('reviewsContent');

    function showDetails() {
      detailsTab.classList.add('border-b-2', 'border-indigo-600', 'text-gray-900');
      reviewsTab.classList.remove('border-b-2', 'border-indigo-600', 'text-gray-900');
      detailsContent.classList.remove('hidden');
      reviewsContent.classList.add('hidden');
    }

    function showReviews() {
      reviewsTab.classList.add('border-b-2', 'border-indigo-600', 'text-gray-900');
      detailsTab.classList.remove('border-b-2', 'border-indigo-600', 'text-gray-900');
      reviewsContent.classList.remove('hidden');
      detailsContent.classList.add('hidden');
    }

    if (detailsTab && reviewsTab && detailsContent && reviewsContent) {
      detailsTab.addEventListener('click', showDetails);
      reviewsTab.addEventListener('click', showReviews);
      // Default to details tab
      showDetails();
    }

    // Review form star interaction
    const stars = document.querySelectorAll('#starContainer i');
    const ratingInput = document.getElementById('ratingInput');

    function updateStars(selectedValue) {
      stars.forEach((star, index) => {
        if (index < selectedValue) {
          star.style.color = '#fbbf24';
          star.classList.add('fas');
          star.classList.remove('far');
        } else {
          star.style.color = '#d1d5db';
          star.classList.remove('fas');
          star.classList.add('far');
        }
      });
    }

    if (stars.length > 0) {
      stars.forEach(star => {
        star.addEventListener('click', () => {
          const value = parseInt(star.dataset.value);
          ratingInput.value = value;
          updateStars(value);
        });
        star.addEventListener('mouseover', () => {
          updateStars(parseInt(star.dataset.value));
        });
        star.addEventListener('mouseout', () => {
          updateStars(parseInt(ratingInput.value) || 0);
        });
      });

      // Initial stars
      updateStars({{ initial_rating }});
    }

    // AJAX Review Submit
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
      reviewForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!ratingInput.value || parseInt(ratingInput.value) < 1) {
          showSweetAlert('Please select a rating.', 'warning');
          return;
        }

        const formData = new FormData(reviewForm);
        try {
          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await response.json();
          if (data.success) {
            // Append new review
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.insertAdjacentHTML('afterbegin', data.review_html);
            
            // Update average display
            const avgDisplay = reviewsContent.querySelector('.text-3xl');
            const countDisplay = reviewsContent.querySelector('p.text-gray-600:last-child');
            avgDisplay.textContent = data.new_avg.toFixed(1);
            countDisplay.textContent = `${data.new_count} Review${data.new_count !== 1 ? 's' : ''}`;
            // Update tab count
            reviewsTab.textContent = `Reviews (${data.new_count})`;
            // Update top rating display
            const topAvg = document.querySelector('.text-3xl.font-bold.text-gray-900');
            if (topAvg) topAvg.textContent = data.new_avg.toFixed(1);
            const topCount = document.querySelector('span.text-indigo-600');
            if (topCount) topCount.textContent = `(${data.new_count} Review${data.new_count !== 1 ? 's' : ''})`;
            
            reviewForm.reset();
            ratingInput.value = '0';
            updateStars(0);
            showSweetAlert('Review submitted successfully!', 'success');
          } else {
            showSweetAlert('Error submitting review.', 'error');
          }
        } catch (error) {
          showSweetAlert('An error occurred. Please try again.', 'error');
        }
      });
    }

    // Auto-hide initial messages (if any)
    {% if messages %}
      {% for message in messages %}
        showSweetAlert("{{ message }}", "{{ message.tags }}");
      {% endfor %}
    {% endif %}
  });
</script>

<style>
  .swal2-small {
    width: 300px !important;
    padding: 10px !important;
    font-size: 14px !important;
  }
</style>
{% endblock %}