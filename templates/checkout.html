{% extends 'header.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}
<div class="bg-slate-50 py-12 px-4 sm:px-10">
    <div class="max-w-6xl mx-auto">

        <!-- Breadcrumb -->
        <div class="text-md text-gray-500 mb-6">
            <span class="text-black font-bold">Checkout</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

            <!-- LEFT: Address + Payment -->
            <div class="md:col-span-2 bg-white rounded-xl p-6 shadow h-fit ">

                <!-- Address -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Shipping address</h2>
                    <button onclick="toggleModal('addModal')"
                        class="px-4 py-1.5 bg-black text-white text-sm rounded hover:bg-gray-800">+ Add new</button>
                </div>

                <!-- Dropdown -->
                {% if addresses %}
                <div class="mb-6">
                    <select id="addressDropdown" onchange="fillAddressForm()"
                        class="px-3 py-2 border rounded-md text-sm text-gray-700 w-auto">
                        {% for address in addresses %}
                        <option value="{{ address.id }}" data-full_name="{{ address.full_name }}"
                            data-mobile="{{ address.mobile }}" data-address_line="{{ address.address_line }}"
                            data-district="{{ address.district }}" data-state="{{ address.state }}"
                            data-pin_code="{{ address.pin_code }}" data-country="{{ address.country }}"
                            {% if address.is_default %}selected{% endif %}>
                            {{ address.full_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Selected Address -->
                <form id="addressForm" method="post" action="{% url 'update_address' addresses.0.id %}?next=/checkout/">
                    {% csrf_token %}
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <input type="text" id="address_line" name="address_line" placeholder="Street Address"
                            class="bg-slate-100 p-2 rounded" readonly>
                        <input type="text" id="district" name="district" placeholder="District"
                            class="bg-slate-100 p-2 rounded" readonly>
                        <input type="text" id="full_name" name="full_name" placeholder="Full Name"
                            class="bg-slate-100 p-2 rounded" readonly>
                        <input type="text" id="pin_code" name="pin_code" placeholder="Pin Code"
                            class="bg-slate-100 p-2 rounded" readonly>
                        <input type="text" id="state" name="state" placeholder="State" class="bg-slate-100 p-2 rounded"
                            readonly>
                        <input type="text" id="mobile" name="mobile" placeholder="Mobile"
                            class="bg-slate-100 p-2 rounded" readonly>
                        <input type="text" id="country" name="country" placeholder="Country"
                            class="bg-slate-100 p-2 rounded" readonly>
                    </div>

                    <div class="mt-4 flex gap-2">
                        <button type="button" onclick="makeEditable()"
                            class="bg-black text-white px-4 py-2 rounded">Edit</button>
                        <button type="submit" class="bg-gray-600 text-white px-4 py-2 rounded hidden"
                            id="saveBtn">Save</button>
                    </div>
                </form>
                {% else %}
                <p class="text-red-500 text-sm">No address found. Add a new one to continue.</p>
                {% endif %}

                <form id="checkoutForm" method="post" action="{% url 'place_order' %}">
                    {% csrf_token %}
                    <input type="hidden" name="selected_address" id="hiddenAddressId" value="{% if addresses %}{{ addresses.0.id }}{% endif %}">

                    <div class="mt-9 border-0 shadow rounded p-4">
                        <h2 class="text-base font-semibold mb-2">Payment Methods</h2>
                        <p class="text-sm text-gray-500 mb-4">Select one payment method</p>
                        <div class="space-y-3 text-sm">
                            <label class="flex items-center gap-2 text-sm" id="cod-label">
                                {% if final_total > 1000 %}
                                <input type="radio" disabled class="accent-blue-600" id="cod-radio">
                                <i data-lucide="banknote" class="w-4 h-4 text-gray-600"></i>
                                <span class="line-through text-gray-400">Cash on Delivery</span>
                                <span class="text-red-500 text-xs ml-2 cod-notice" id="cod-notice">(COD not available for orders above ₹1000)</span>
                                {% else %}
                                <input type="radio" name="payment_method" value="cod" class="accent-blue-600" checked id="cod-radio">
                                <i data-lucide="banknote" class="w-4 h-4 text-gray-600"></i>
                                <span>Cash on Delivery</span>
                                {% endif %}
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="payment_method" value="wallet" class="accent-blue-600" id="wallet-radio">
                                <i data-lucide="wallet" class="w-4 h-4 text-gray-600"></i>
                                <span>Wallet</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="payment_method" value="razorpay" class="accent-blue-600" id="razorpay-radio">
                                <i data-lucide="credit-card" class="w-4 h-4 text-gray-600"></i>
                                <span>Pay Online (Razorpay)</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gray-900 text-white py-2 rounded-lg font-semibold hover:bg-gray-800 mt-6 mb-6 md:mb-0">
                        Place Order
                    </button>
                </form>
            </div>

            <!-- RIGHT: Order Summary -->
            <div class="bg-white rounded-xl p-6 shadow h-fit md:sticky md:top-20 mt-8 md:mt-0">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Your Order</h3>

                <div class="space-y-4 mb-4">
                    {% for item in cart_items %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <img src="{% if item.color_variant and item.color_variant.images.first %}{{ item.color_variant.images.first.image.url }}{% else %}{{ item.product.thumbnail.url }}{% endif %}" class="w-10 h-10 object-cover rounded border"
                                alt="{{ item.product.name }}" onerror="this.src='{% static 'images/user.png' %}'; this.onerror=null;">
                            <div>
                                <p class="text-xs font-small">{{ item.size_stock.size }}</p>
                                <p class="text-xs text-gray-500">Qty: {{ item.quantity }}</p>
                            </div>
                        </div>
                        <div class="text-sm font-semibold">
                            {% with final_price=item.product.get_final_price %}
                                ₹{{ final_price|mul:item.quantity|floatformat:2 }}
                            {% endwith %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Price Breakdown -->
                <div class="space-y-2 text-sm text-slate-700 mt-6" id="price-breakdown">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span id="subtotal-val">₹{{ subtotal|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between text-green-600" id="product-discount-row">
                        <span>Product Discount:</span>
                        <span id="total-discount-val">-₹{{ total_discount|floatformat:2 }}</span>
                    </div>
                    {% if applied_coupon %}
                    <div class="flex justify-between text-green-600" id="coupon-discount-row">
                        <span>Coupon Discount :</span>
                        <span id="coupon-discount-val">-₹{{ coupon_discount|floatformat:2 }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span>Tax (5%):</span>
                        <span id="taxes-val">₹{{ taxes|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Shipping:</span>
                        <span>Free</span>
                    </div>
                    <hr class="my-2">
                    <div class="flex justify-between font-bold text-base text-slate-900">
                        <span>Total:</span>
                        <span id="final-total-val">₹{{ final_total|floatformat:2 }}</span>
                    </div>
                </div>

                <div class="mt-6">
                    <a href="{% url 'cart_view' %}" class="w-full inline-block bg-gray-200 text-gray-800 py-2 px-4 rounded-lg text-center text-sm font-medium hover:bg-gray-300">
                        Edit Cart
                    </a>
                </div>

                <!-- Coupon Section -->
                <div class="mt-6 pt-6 border-t">
                    {% if applied_coupon %}
                    <div class="bg-gray-100 rounded-md p-3 flex justify-between items-center" id="applied-coupon-section">
                        <div>
                            <p class="text-sm font-semibold">COUPONS</p>
                            <p class="text-xs">1 Coupon applied</p>
                            <p class="text-xs text-green-600" id="savings-val">You saved additional ₹{{ applied_coupon.discount_amount|floatformat:0 }}</p>
                        </div>
                        <form method="POST" action="{% url 'remove_coupon' %}" id="remove-coupon-form">
                            {% csrf_token %}
                            <input type="hidden" name="coupon_code" value="{{ applied_coupon.code }}">
                            <button type="submit" class="text-red-600 text-sm border border-red-600 px-3 py-1 rounded hover:bg-red-100">
                                Remove
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div id="no-coupon-section">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-sm text-gray-500 italic">
                                (If you have any coupons)
                            </div>
                            <button id="view-coupons" class="text-sm underline cursor-pointer text-gray-500 hover:text-gray-900">
                                View Coupons
                            </button>
                        </div>
                        <div id="couponDropdown" class="hidden mt-4 bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                            <h4 class="text-sm font-semibold text-gray-600 mb-4">Available Coupons</h4>
                            <ul class="space-y-3">
                                {% if coupons %}
                                {% for coupon in coupons %}
                                <li class="flex items-center justify-between gap-4 p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition border border-gray-100 {% if coupon_status|get_item:coupon.id %}opacity-50{% endif %}">
                                    <div class="flex-1">
                                        <p class="font-semibold text-blue-700 text-sm {% if coupon_status|get_item:coupon.id %}line-through text-red-500{% endif %}">{{ coupon.code }}</p>
                                        <p class="text-xs text-gray-500">₹{{ coupon.discount_amount|floatformat:2 }} off</p>
                                        <p class="text-xs text-gray-500">Min: ₹{{ coupon.minimum_order_amount|floatformat:2 }}</p>
                                        <p class="text-xs text-gray-500">Valid till: {{ coupon.valid_to|date:"M d, Y" }}</p>
                                    </div>
                                    {% if taxable_amount >= coupon.minimum_order_amount and not coupon_status|get_item:coupon.id %}
                                    <form method="POST" action="{% url 'apply_coupon' %}" class="coupon-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="coupon_code" value="{{ coupon.code }}">
                                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition shadow-sm">
                                            Apply
                                        </button>
                                    </form>
                                    {% elif coupon_status|get_item:coupon.id %}
                                    <span class="text-xs text-red-500">Already Used</span>
                                    {% else %}
                                    <span class="text-xs text-red-500">Not eligible</span>
                                    {% endif %}
                                </li>
                                {% endfor %}
                                {% else %}
                                <p class="text-gray-500 text-sm text-center">No active available coupons.</p>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Hidden JS for Django Messages & Coupon Error (injects array for toasts) -->
                    {% if messages or coupon_error %}
                    <script>
                        // Collect all messages into an array for SweetAlert
                        const djangoMessages = [
                            {% if coupon_error %}
                                {type: 'error', text: '{{ coupon_error|escapejs }}'},
                            {% endif %}
                            {% if messages %}
                                {% for message in messages %}
                                    {type: '{% if "success" in message.tags %}success{% elif "error" in message.tags %}error{% elif "warning" in message.tags %}warning{% else %}info{% endif %}', text: '{{ message.message|escapejs }}'},
                                {% endfor %}
                            {% endif %}
                        ];
                    </script>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Address Modal -->
<div id="addModal" class="fixed inset-0 hidden bg-black bg-opacity-30 flex items-center justify-center z-50">
    <div class="bg-white rounded p-6 w-full max-w-xl relative">
        <button onclick="toggleModal('addModal')" class="absolute top-2 right-4 text-xl">✖</button>
        <h3 class="text-lg font-bold mb-4">Add New Address</h3>
        <form method="post" action="{% url 'add_address' %}?next=/checkout/" id="addAddressForm">
            {% csrf_token %}
            <div class="grid grid-cols-2 gap-4">
                <input name="full_name" placeholder="Full Name" required class="border p-2 rounded">
                <input name="mobile" placeholder="Mobile" required class="border p-2 rounded">
                <input name="address_line" placeholder="Street/Area" required class="border p-2 rounded">
                <input name="district" placeholder="District" required class="border p-2 rounded">
                <input name="state" placeholder="State" required class="border p-2 rounded">
                <input name="pin_code" placeholder="Pincode" required class="border p-2 rounded">
                <input name="country" placeholder="Country" required class="border p-2 rounded">
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button type="button" onclick="toggleModal('addModal')" class="px-4 py-2 border rounded">Cancel</button>
                <button type="submit" class="bg-black text-white px-4 py-2 rounded">Save Address</button>
            </div>
        </form>
    </div>
</div>

<!-- Validation Modal -->
<div id="validationModal" class="fixed inset-0 hidden bg-black bg-opacity-30 flex items-center justify-center z-50">
    <div class="bg-white rounded p-6 w-full max-w-md text-center relative">
        <button onclick="toggleModal('validationModal')" class="absolute top-2 right-4 text-xl">✖</button>
        <h3 class="text-lg font-bold mb-4">Validation Error</h3>
        <p class="text-sm text-gray-700">Please select an address and payment method.</p>
        <button onclick="toggleModal('validationModal')" class="mt-4 bg-gray-900 text-white px-4 py-2 rounded-lg">OK</button>
    </div>
</div>

<script>
    function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.toggle("hidden");
        }
    }

    function makeEditable() {
        document.querySelectorAll("#addressForm input").forEach(input => input.removeAttribute("readonly"));
        document.getElementById("saveBtn").classList.remove("hidden");
    }

    function fillAddressForm() {
        const select = document.getElementById("addressDropdown");
        const option = select.selectedOptions[0];
        if (!option) return;

        const addressId = option.value;
        document.getElementById("addressForm").action = `/addresses/update/${addressId}/?next=/checkout/`;
        document.getElementById("hiddenAddressId").value = addressId;

        document.getElementById("full_name").value = option.dataset.full_name;
        document.getElementById("mobile").value = option.dataset.mobile;
        document.getElementById("address_line").value = option.dataset.address_line;
        document.getElementById("district").value = option.dataset.district;
        document.getElementById("state").value = option.dataset.state;
        document.getElementById("pin_code").value = option.dataset.pin_code;
        document.getElementById("country").value = option.dataset.country;
    }

    // SweetAlert Toast Function
    function showSweetAlert(message, type) {
        const iconMap = {
            'success': 'success',
            'error': 'error',
            'info': 'info',
            'warning': 'warning'
        };
        const icon = iconMap[type] || 'info';
        Swal.fire({
            text: message,
            icon: icon,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            customClass: {
                popup: 'swal2-small'
            }
        });
    }

    // NEW: Update Payment Options based on final_total
    function updatePaymentOptions(finalTotal) {
        const codRadio = document.getElementById('cod-radio');
        const codLabel = document.getElementById('cod-label');
        const codNotice = document.getElementById('cod-notice');
        const isOver1000 = finalTotal > 1000;

        if (isOver1000) {
            codRadio.disabled = true;
            codRadio.checked = false;
            if (!codNotice) {
                const noticeSpan = document.createElement('span');
                noticeSpan.className = 'text-red-500 text-xs ml-2 cod-notice';
                noticeSpan.id = 'cod-notice';
                noticeSpan.textContent = '(COD not available for orders above ₹1000)';
                const codSpan = codLabel.querySelector('span:not(.cod-notice)');
                codSpan.insertAdjacentElement('afterend', noticeSpan);
                const existingNotice = document.getElementById('cod-notice');
                if (existingNotice) existingNotice.remove();
            }
            // Default to wallet if COD was checked
            if (codRadio.checked) {
                document.getElementById('wallet-radio').checked = true;
            }
        } else {
            codRadio.disabled = false;
            const notice = document.querySelector('.cod-notice');
            if (notice) notice.remove();
        }
    }

    // NEW: Update Price Breakdown
    function updatePrices(totals) {
        document.getElementById('subtotal-val').textContent = `₹${totals.subtotal.toFixed(2)}`;
        document.getElementById('total-discount-val').textContent = `-₹${totals.total_discount.toFixed(2)}`;
        document.getElementById('taxes-val').textContent = `₹${totals.taxes.toFixed(2)}`;
        document.getElementById('final-total-val').textContent = `₹${totals.final_total.toFixed(2)}`;

        const couponRow = document.getElementById('coupon-discount-row');
        const couponDiscount = totals.coupon_discount;
        if (couponDiscount > 0) {
            if (!couponRow) {
                const productDiscountRow = document.getElementById('product-discount-row');
                const newRow = document.createElement('div');
                newRow.className = 'flex justify-between text-green-600';
                newRow.id = 'coupon-discount-row';
                newRow.innerHTML = `
                    <span>Coupon Discount :</span>
                    <span id="coupon-discount-val">-₹${couponDiscount.toFixed(2)}</span>
                `;
                productDiscountRow.insertAdjacentElement('afterend', newRow);
            } else {
                document.getElementById('coupon-discount-val').textContent = `-₹${couponDiscount.toFixed(2)}`;
            }
        } else if (couponRow) {
            couponRow.remove();
        }

        // Update savings in applied section if visible
        const savingsVal = document.getElementById('savings-val');
        if (savingsVal) {
            savingsVal.textContent = `You saved additional ₹${Math.round(couponDiscount)}`;
        }

        updatePaymentOptions(totals.final_total);
    }

    // NEW: Handle Apply Success (dynamic insert)
    function handleApplySuccess(data) {
        showSweetAlert(data.message, 'success');

        // Hide no-coupon section
        const noCouponSection = document.getElementById('no-coupon-section');
        if (noCouponSection) noCouponSection.style.display = 'none';

        // Create/insert applied section
        let appliedSection = document.getElementById('applied-coupon-section');
        if (!appliedSection) {
            appliedSection = document.createElement('div');
            appliedSection.className = 'bg-gray-100 rounded-md p-3 flex justify-between items-center';
            appliedSection.id = 'applied-coupon-section';
            const couponSection = document.querySelector('.mt-6.pt-6.border-t');
            couponSection.insertBefore(appliedSection, noCouponSection);
        }
        const coupon = data.coupon;
        appliedSection.innerHTML = `
            <div>
                <p class="text-sm font-semibold">COUPONS</p>
                <p class="text-xs">1 Coupon applied</p>
                <p class="text-xs text-green-600" id="savings-val">You saved additional ₹${Math.round(coupon.discount_amount)}</p>
            </div>
            <form method="POST" action="{% url 'remove_coupon' %}" id="remove-coupon-form">
                {% csrf_token %}
                <input type="hidden" name="coupon_code" value="${coupon.code}">
                <button type="submit" class="text-red-600 text-sm border border-red-600 px-3 py-1 rounded hover:bg-red-100">
                    Remove
                </button>
            </form>
        `;

        // Re-attach event listener to new remove form
        const newRemoveForm = appliedSection.querySelector('#remove-coupon-form');
        if (newRemoveForm) {
            newRemoveForm.addEventListener('submit', handleCouponSubmit);
        }

        updatePrices(data.updated_totals);
    }

    // NEW: Handle Remove Success (dynamic remove)
    function handleRemoveSuccess(data) {
        showSweetAlert(data.message, 'success');

        // Remove applied section
        const appliedSection = document.getElementById('applied-coupon-section');
        if (appliedSection) appliedSection.remove();

        // Show no-coupon section
        const noCouponSection = document.getElementById('no-coupon-section');
        if (noCouponSection) noCouponSection.style.display = 'block';

        updatePrices(data.updated_totals);
    }

    // UPDATED: Unified Coupon Submit Handler
    function handleCouponSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const url = form.action;
        const isRemove = form.id === 'remove-coupon-form';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (isRemove) {
                    handleRemoveSuccess(data);
                } else {
                    handleApplySuccess(data);
                }
            } else {
                showSweetAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Coupon AJAX Error:', error);
            showSweetAlert('An error occurred while processing the coupon. Please try again.', 'error');
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const newAddressId = urlParams.get('new_address_id');
        const dropdown = document.getElementById("addressDropdown");

        if (dropdown) {
            if (newAddressId) {
                dropdown.value = newAddressId;
            }
            fillAddressForm();
        }

        lucide.createIcons();

        // Client-side validation for Place Order form
        document.getElementById('checkoutForm').addEventListener('submit', function (e) {
            const addressId = document.getElementById('hiddenAddressId').value;
            const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
            if (!addressId || !paymentMethod) {
                e.preventDefault();
                toggleModal('validationModal');
            }
        });

        // Coupon Dropdown Toggle
        const viewCouponsBtn = document.getElementById('view-coupons');
        const couponDropdown = document.getElementById('couponDropdown');

        if (viewCouponsBtn) {
            viewCouponsBtn.addEventListener('click', function () {
                if (couponDropdown) {
                    couponDropdown.classList.toggle('hidden');
                }
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            if (couponDropdown && !couponDropdown.contains(event.target) && viewCouponsBtn && !viewCouponsBtn.contains(event.target)) {
                couponDropdown.classList.add('hidden');
            }
        });

        // Handle Django Messages on Page Load
        if (typeof djangoMessages !== 'undefined' && djangoMessages.length > 0) {
            djangoMessages.forEach(msg => {
                showSweetAlert(msg.text, msg.type);
            });
        }

        // Initial payment options update
        const initialFinalTotal = parseFloat('{{ final_total|floatformat:2 }}');
        updatePaymentOptions(initialFinalTotal);

        // Attach unified handler to all coupon forms
        document.querySelectorAll('.coupon-form, #remove-coupon-form').forEach(form => {
            form.addEventListener('submit', handleCouponSubmit);
        });
    });
</script>

<!-- Include SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/lucide@latest"></script>
{% endblock %}